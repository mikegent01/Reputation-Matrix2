<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vigilance Terminal | Special Mission</title>
    <link rel="stylesheet" href="global.css" />
    <link rel="stylesheet" href="layout.css" />
    <link rel="stylesheet" href="components.css" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    <style>
        /* Basic layout for the mission page */
        .metrics-board {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
            margin: 16px 0 24px;
        }
        .metric { background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; }
        .metric-header { display: flex; justify-content: space-between; font-family: "Roboto Mono", monospace; font-size: 0.9rem; color: #a9ffea; }
        .metric-bar { height: 8px; background: rgba(255,255,255,0.08); border-radius: 6px; overflow: hidden; margin-top: 8px; }
        .metric-fill { height: 100%; width: 0%; background: linear-gradient(90deg,#2bd1ff,#4eff9e); transition: width 300ms ease; }

        .dialogue-panel { background: rgba(255,255,255,0.03); border: 1px dashed rgba(255,255,255,0.12); padding: 16px; border-radius: 8px; margin: 12px 0 20px; font-family: 'Shadows Into Light Two', 'Roboto Mono', monospace; font-size: 1.1rem; color: #cbe6ff; line-height: 1.7; }
        .dialogue-line .speaker { font-family: "Orbitron", sans-serif; color: #ffd54e; font-weight: bold; }
        
        .decision-container { margin: 24px 0; padding: 16px; border-left: 3px solid #4eff9e; background: rgba(78, 255, 158, 0.05); border-radius: 0 8px 8px 0; }
        .decision-title { font-family: "Orbitron", sans-serif; font-size: 1.4rem; margin-bottom: 8px; color: #4eff9e; }
        .decision-narrative { font-family: "Roboto Mono", monospace; color: #cbe6ff; }
        
        .choices-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin-top: 24px; }
        .decision-card { border: 1px solid rgba(255,255,255,0.12); border-radius: 10px; padding: 16px; background: rgba(255,255,255,0.04); display: flex; flex-direction: column; transition: all 0.2s ease-in-out; }
        .decision-card:hover { border-color: var(--accent-hover); transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .decision-card-title { font-family: 'Orbitron', sans-serif; font-weight: 700; margin-bottom: 8px; color: #a9ffea; font-size: 1.1rem; }
        .decision-card-desc { flex: 1; font-size: 0.95rem; color: #e8f5ff; line-height: 1.5; }
        .decision-actions { display: flex; justify-content: flex-end; gap: 8px; margin-top: 12px; }
        
        .btn { cursor: pointer; border: none; border-radius: 6px; padding: 10px 16px; font-family: "Roboto Mono", monospace; font-weight: bold; text-decoration: none; }
        .btn-primary { background: #2bd1ff; color: #0a0f14; transition: background-color 0.2s; }
        .btn-primary:hover { background-color: #5ce1ff; }
        
        /* Final Plan Styles */
        .final-plan-summary { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-top: 16px;}
        @media (max-width: 768px) { .final-plan-summary { grid-template-columns: 1fr; } }
        .summary-choices ul { list-style: none; padding-left: 0; }
        .summary-choices li { background: rgba(255,255,255,0.04); padding: 8px; border-radius: 4px; margin-bottom: 8px; font-size: 0.9rem;}
        .summary-choices strong { color: #a9ffea; display: block; font-family: "Orbitron", sans-serif; font-size: 0.8rem; margin-bottom: 4px;}
        #mission-brief-textarea { width: 100%; height: 200px; background: #010409; color: #4eff9e; border: 1px solid var(--border-color); font-family: "Roboto Mono", monospace; padding: 12px; border-radius: 6px; margin-top: 12px; }
        
        .modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); z-index: 1000; }
        .modal.open { display: flex; animation: fadeIn 0.3s ease-out; }
        .modal-content { background: #0a0f14; border: 1px solid rgba(255,255,255,0.12); border-radius: 10px; padding: 24px; width: min(500px, 92vw); position: relative; }
        .modal-close { position: absolute; top: 10px; right: 10px; font-size: 1.5rem; background: transparent; color: #e8f5ff; border: none; cursor: pointer; transition: transform 0.2s; }
        .modal-close:hover { transform: scale(1.2); }
        .modal-content h3 { font-family: 'Orbitron', sans-serif; color: var(--neutral-color); margin-bottom: 16px; }
        .modal-content ul { list-style: none; padding-left: 0; }
        .modal-content li { margin-bottom: 8px; font-family: 'Roboto Mono', monospace; }
        .modal-actions { display: flex; justify-content: flex-end; margin-top: 24px; }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Shadows+Into+Light+Two&display=swap" rel="stylesheet">
</head>
<body>
    <div class="tablet-frame">
        <div class="scanline-overlay"></div>
        <div id="app">
            <aside id="sidebar"></aside>
            <main id="main-content">
                <section id="mission-section">
                    <h2 class="page-title">Special Mission: The Vigilance Gambit</h2>
                    <p class="page-subtitle">
                        While exploring the crashed Vigilance, the toads have discovered the hidden cargo hold: over 150 trafficked toads, weak and disoriented. This discovery has caused a schism. Lee's 'Strike Faction' sees an army. Roger's 'Shelter Faction' sees mouths to feed. As their trusted leader, you must forge a plan.
                    </p>

                    <div id="mission-metrics" class="metrics-board">
                        <div class="metric">
                            <div class="metric-header">
                                <span>Toad Morale</span><span id="m-morale-val">0</span>
                            </div>
                            <div class="metric-bar"><div id="m-morale" class="metric-fill"></div></div>
                        </div>
                        <div class="metric">
                            <div class="metric-header">
                                <span>Plan Effectiveness</span><span id="m-resources-val">0</span>
                            </div>
                            <div class="metric-bar"><div id="m-resources" class="metric-fill"></div></div>
                        </div>
                        <div class="metric">
                            <div class="metric-header">
                                <span>Plan Subtlety</span><span id="m-stealth-val">0</span>
                            </div>
                            <div class="metric-bar"><div id="m-stealth" class="metric-fill"></div></div>
                        </div>
                        <div class="metric">
                            <div class="metric-header">
                                <span>Group Cohesion</span><span id="m-cohesion-val">0</span>
                            </div>
                            <div class="metric-bar"><div id="m-cohesion" class="metric-fill"></div></div>
                        </div>
                    </div>

                    <div id="dialogue" class="dialogue-panel">
                        Archie—I slipped this in your pocket. Please read it. We found them. Over 150 of our people, trapped in the cargo bay. But now we're falling apart. Lee wants to arm them, turn them into an army and strike out. Roger says we'll starve, that we need to find shelter first. They're going to fight. You're the only one they'll both listen to. You have to decide our path. Please.
                        <div style="text-align: right; margin-top: 8px;">—Dan</div>
                    </div>

                    <div id="decision-container">
                        <!-- Decisions or final plan injected here -->
                    </div>

                </section>
            </main>
        </div>
    </div>

    <div id="consequence-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h3 id="consequence-title">Consequences</h3>
            <div id="consequence-body"></div>
            <div class="modal-actions">
                <button id="modal-continue" class="btn btn-primary">Continue</button>
            </div>
        </div>
    </div>

    <script type="module" src="common.js"></script>
    <script type="module" src="navigation.js"></script>
    <script type="module">
        const STORAGE_KEY = 'vigi.vigilanceGambitPlan';

        const defaultState = {
          decisionIndex: 0,
          metrics: { morale: 50, resources: 40, stealth: 60, cohesion: 40 },
          choicesMade: [],
          outcome: null,
        };

        const DECISION_POINTS = [
          {
            id: 'objective',
            title: 'Decision 1: The New Arrivals',
            narrative: 'The fundamental dilemma. The 150 freed toads are a resource, but also a burden. Do you treat them as soldiers or survivors? This decision will set the tone for the entire operation.',
            choices: [
              { id: 'army', title: "Lee's Plan: An Army is Born", desc: "View the new arrivals as recruits. Prioritize arming and training them immediately. Our survival depends on strength and seizing territory now.", deltas: { morale: +20, cohesion: -20, resources: +15, stealth: -10 } },
              { id: 'survivors', title: "Roger's Plan: Protect the Flock", desc: "View the new arrivals as refugees. Prioritize their health, safety, and finding a secure shelter above all else. We cannot fight a war while our people starve.", deltas: { morale: -10, cohesion: -15, resources: -10, stealth: +15 } }
            ]
          },
          {
            id: 'approach',
            title: 'Decision 2: The Vigilance Itself',
            narrative: 'The ship is both a prison and our greatest asset. Its resources are finite. How do we use what remains of the wreck?',
            choices: [
              { id: 'strip', title: "Strip the Ship for a Fortification", desc: "Tear armor plating and systems from the Vigilance to build a defensible ground-based fort. It's a permanent, safe shelter, but sacrifices the ship's potential.", deltas: { stealth: +10, resources: +20, cohesion: +10 } },
              { id: 'repair', title: "Attempt to Make the Ship Mobile", desc: "Conserve resources to repair the Vigilance's essential systems. A mobile base is a powerful weapon, but it leaves us vulnerable in the open.", deltas: { stealth: -20, resources: -15, cohesion: -5 } }
            ]
          },
          {
            id: 'entry',
            title: 'Decision 3: The Staff in the Core',
            narrative: 'The staff is our only power source, but Dan insists it\'s a dangerous artifact. Ryan is studying the Iron Legion seal on it. What is the protocol regarding this immense power source?',
            choices: [
              { id: 'unseal', title: "Risk Unsealing It", desc: "Task Ryan with finding a way to break the Iron Binding. The potential power is immense, but a magical backlash could be catastrophic.", deltas: { resources: +30, morale: +10, stealth: -25, cohesion: -5 } },
              { id: 'leave', title: "Leave it Sealed", desc: "The risk is too great. We work with the limited power we have. It's safer and keeps the ship's energy signature low.", deltas: { resources: -10, stealth: +20, cohesion: +5 } }
            ]
          },
          {
            id: 'contingency',
            title: 'Decision 4: The First Step',
            narrative: 'Based on the previous choices, what is our immediate, actionable priority? This will be the first mission the newly-unified (or fractured) toads undertake.',
            choices: [
              { id: 'scout', title: "Scout for a Permanent Base", desc: "Send out small, stealthy teams to find a defensible location to establish a long-term shelter, 'Toad's Landing'.", deltas: { stealth: +15, morale: -5, cohesion: +10 } },
              { id: 'raid', title: "Raid for Weapons & Supplies", desc: "Launch an aggressive raid on a nearby Iron Legion scavenger camp to acquire weapons and resources.", deltas: { stealth: -20, morale: +15, cohesion: -5, resources: +10 } }
            ]
          }
        ];

        function loadState() {
          try {
            const raw = localStorage.getItem(STORAGE_KEY);
            return raw ? JSON.parse(raw) : JSON.parse(JSON.stringify(defaultState));
          } catch {
            return JSON.parse(JSON.stringify(defaultState));
          }
        }
        function saveState(state) {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        }

        function clamp(v) { return Math.max(0, Math.min(100, v)); }

        function applyDeltas(state, deltas) {
          const m = state.metrics;
          m.morale = clamp(m.morale + (deltas.morale || 0));
          m.resources = clamp(m.resources + (deltas.resources || 0));
          m.stealth = clamp(m.stealth + (deltas.stealth || 0));
          m.cohesion = clamp(m.cohesion + (deltas.cohesion || 0));
        }

        function renderMetrics(state) {
          const metrics = state.metrics;
          const set = (id, val) => {
            const bar = document.getElementById(id);
            if (bar) bar.style.width = `${clamp(val)}%`;
            const valEl = document.getElementById(`${id}-val`);
            if (valEl) valEl.textContent = clamp(val);
          };
          set('m-morale', metrics.morale);
          set('m-resources', metrics.resources);
          set('m-stealth', metrics.stealth);
          set('m-cohesion', metrics.cohesion);
        }
        
        function onChoose(state, choice) {
          applyDeltas(state, choice.deltas);
          
          const currentDecision = DECISION_POINTS[state.decisionIndex];
          state.choicesMade.push({
              decisionTitle: currentDecision.title,
              choiceTitle: choice.title,
              choiceId: choice.id
          });

          state.decisionIndex++;

          if (state.decisionIndex >= DECISION_POINTS.length) {
            state.outcome = evaluateOutcome(state);
          }

          saveState(state);
          renderMetrics(state);
          showConsequences(choice.deltas, () => renderDecisionPoint(state));
        }
        
        function evaluateOutcome(state) {
          const m = state.metrics;
          if (m.stealth >= 75 && m.cohesion >= 60) return 'stealthSuccess';
          if (m.morale >= 70 && m.resources >= 60) return 'aggressiveSuccess';
          if (m.cohesion <= 30) return 'fractured';
          if (m.stealth <= 25) return 'exposed';
          return 'mixed';
        }
        
        function getOutcomeText(state) {
            switch(state.outcome) {
                case 'stealthSuccess': return 'An excellent, well-balanced plan. It prioritizes the group\'s safety and unity while aiming for long-term survival. The odds of success are high, and the risk of immediate discovery is minimal. The team feels cautious but hopeful.';
                case 'aggressiveSuccess': return 'A bold and aggressive strategy. This plan favors overwhelming force and decisive action to carve out a place in the world. While extremely risky, its success would bring a huge morale boost and significant resources. The team is fired up, though some worry about the potential for attracting powerful enemies.';
                case 'fractured': return 'The planning process has exposed deep divisions within the group. While a plan has been formed, the team is not united behind it. Cohesion is critically low, and the risk of insubordination during the mission is dangerously high. The group may shatter under pressure.';
                case 'exposed': return 'This is a loud and extremely risky plan. It sacrifices all elements of surprise for speed and immediate gains. The chances of alerting every hostile force in the area are almost certain. The potential rewards are high, but so is the likelihood of a disastrous confrontation that could wipe the toads out for good.';
                default: return 'A workable, if uninspired, plan. It\'s a series of compromises that leaves no faction truly satisfied. The mission can likely be accomplished, but the underlying tensions within the group remain unresolved and will likely fester.';
            }
        }

        function generateMissionBrief(state) {
            let brief = "OPERATION: VIGILANCE GAMBIT\n\n";
            brief += "MISSION BRIEFING:\n";
            
            const objective = state.choicesMade[0];
            brief += `- PRIMARY DIRECTIVE: ${objective.choiceId === 'army' ? 'Militarize the 150 freed toads for immediate action.' : 'Prioritize the shelter and well-being of the 150 freed toads.'}\n`;
            
            const approach = state.choicesMade[1];
            brief += `- ASSET DOCTRINE: ${approach.choiceId === 'strip' ? 'The Vigilance will be stripped to create a static, fortified base.' : 'Resources will be focused on repairing the Vigilance for mobile operations.'}\n`;

            const entry = state.choicesMade[2];
            brief += `- POWER SOURCE PROTOCOL: ${entry.choiceId === 'unseal' ? 'Attempt to break the Iron Legion seal on the staff for maximum power.' : 'The staff will remain sealed to minimize risk and energy signature.'}\n`;

            const contingency = state.choicesMade[3];
            brief += `- IMMEDIATE OBJECTIVE: ${contingency.choiceId === 'scout' ? 'Initiate stealth reconnaissance to find a permanent base location.' : 'Launch an immediate raid on local hostiles for supplies and weapons.'}\n\n`;

            brief += "This plan is now locked. Execute on my command.\n- Archie";
            return brief;
        }

        function renderFinalPlan(state) {
            const container = document.getElementById('decision-container');
            const choicesListHTML = state.choicesMade.map(c => `<li><strong>${c.decisionTitle}:</strong> ${c.choiceTitle}</li>`).join('');
            const outcomeText = getOutcomeText(state);
            const missionBrief = generateMissionBrief(state);

            container.innerHTML = `
                <div class="decision-title">Mission Plan Finalized</div>
                <div class="decision-narrative">${outcomeText}</div>
                <div class="final-plan-summary">
                    <div class="summary-choices">
                        <h5>Choices Made:</h5>
                        <ul>${choicesListHTML}</ul>
                    </div>
                    <div class="summary-brief">
                        <h5>Generated Mission Brief:</h5>
                        <textarea id="mission-brief-textarea" readonly>${missionBrief}</textarea>
                    </div>
                </div>
                <div class="decision-actions" style="margin-top: 24px; justify-content: center;">
                    <a href="directory.html" class="btn btn-primary">Return to Directory</a>
                </div>
            `;
        }

        function renderDecisionPoint(state) {
            const container = document.getElementById('decision-container');
            
            if (state.decisionIndex >= DECISION_POINTS.length) {
                renderFinalPlan(state);
                return;
            }

            const decision = DECISION_POINTS[state.decisionIndex];
            const choicesHTML = decision.choices.map(choice => `
                <div class="decision-card">
                    <div class="decision-card-title">${choice.title}</div>
                    <p class="decision-card-desc">${choice.desc}</p>
                    <div class="decision-actions">
                        <button class="btn btn-primary" data-choice-id="${choice.id}">Select Plan</button>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = `
                <div class="decision-title">${decision.title}</div>
                <p class="decision-narrative">${decision.narrative}</p>
                <div class="choices-grid">${choicesHTML}</div>
            `;
            
            container.querySelectorAll('.btn-primary').forEach(btn => {
                btn.addEventListener('click', () => {
                    const choiceId = btn.dataset.choiceId;
                    const selectedChoice = decision.choices.find(c => c.id === choiceId);
                    onChoose(state, selectedChoice);
                });
            });
        }
        
        function showConsequences(deltas, onClose) {
          const modal = document.getElementById('consequence-modal');
          const title = document.getElementById('consequence-title');
          const body = document.getElementById('consequence-body');
          const closeBtn = modal.querySelector('.modal-close');
          const contBtn = document.getElementById('modal-continue');

          title.textContent = 'Plan Projection Update';
          body.innerHTML = `
            <ul>
              <li>Toad Morale: ${fmtDelta(deltas.morale)}</li>
              <li>Plan Effectiveness: ${fmtDelta(deltas.resources)}</li>
              <li>Plan Subtlety: ${fmtDelta(deltas.stealth)}</li>
              <li>Group Cohesion: ${fmtDelta(deltas.cohesion)}</li>
            </ul>
          `;
          modal.classList.add('open');

          function close() {
            modal.classList.remove('open');
            onClose && onClose();
          }
          closeBtn.onclick = close;
          contBtn.onclick = close;
        }

        function fmtDelta(v = 0) {
            if (v === 0) return '<span style="color: var(--text-secondary);">No change</span>';
            const sign = v > 0 ? '+' : '';
            const color = v > 0 ? 'var(--positive-color)' : 'var(--negative-color)';
            return `<span style="color: ${color}; font-weight: bold;">${sign}${v}</span>`;
        }

        function init() {
          const state = loadState();
          renderMetrics(state);
          renderDecisionPoint(state);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>